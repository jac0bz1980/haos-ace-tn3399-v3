name: Build HAOS for TN3399-V3

on:
  workflow_dispatch:
    inputs:
      haos_version:
        description: 'HAOS Version (e.g. 12.0)'
        required: true
        default: '12.0'
      kernel_branch:  # 关键修改：参数名从 kernel_version 改为 kernel_branch
        description: 'Kernel Branch (e.g. linux-6.12.y, 需符合Rockchip仓库分支格式)'
        required: true
        default: 'linux-6.12.y'  # 改为仓库标准分支，而非具体补丁版本

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      HAOS_VERSION: ${{ github.event.inputs.haos_version }}
      KERNEL_BRANCH: ${{ github.event.inputs.kernel_branch }}  # 同步修改环境变量名
      WORK_DIR: /home/runner/work/haos-ace-tn3399-v3/haos-build
      CROSS_COMPILE: aarch64-linux-gnu-
      ARCH: arm64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: haos-repo
          fetch-depth: 1

      - name: Cache Dependencies & Build Files
        uses: actions/cache@v3
        with:
          path: |
            /usr/bin/aarch64-linux-gnu-*
            ~/.ccache
            ${{ env.WORK_DIR }}/linux-src
            ${{ env.WORK_DIR }}/rootfs
          # 缓存键同步改为 KERNEL_BRANCH，避免分支变更时复用旧缓存
          key: ${{ runner.os }}-cache-${{ env.HAOS_VERSION }}-${{ env.KERNEL_BRANCH }}
          restore-keys: |
            ${{ runner.os }}-cache-${{ env.HAOS_VERSION }}-
            ${{ runner.os }}-cache-

      - name: Install Required Dependencies
        run: |
          sudo apt update -y && sudo apt install -y \
            make gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            bc flex bison device-tree-compiler ccache kmod cpio \  # 修复：dtc 替换为 device-tree-compiler（适配Ubuntu 24.04）
            parted dosfstools squashfs-tools \
            git wget curl docker.io
          sudo systemctl start docker
          echo "export CCACHE_DIR=~/.ccache" >> ~/.bashrc
          echo "export USE_CCACHE=1" >> ~/.bashrc
          source ~/.bashrc
          ccache -M 5G

      - name: Prepare Work Directory
        run: |
          mkdir -p ${{ env.WORK_DIR }}
          cd ${{ env.WORK_DIR }}
          # 关键修复：克隆时使用仓库标准分支（KERNEL_BRANCH），而非具体补丁版本
          if [ ! -d "linux-src" ]; then
            git clone --branch ${{ env.KERNEL_BRANCH }} \
              https://github.com/rockchip-linux/kernel.git linux-src
          fi
          # 根文件系统下载逻辑不变（若HAOS版本存在则正常下载）
          if [ ! -d "rootfs" ]; then
            # 额外增加：检查HAOS根文件是否存在，避免404错误
            if ! wget --spider https://github.com/home-assistant/operating-system/releases/download/${{ env.HAOS_VERSION }}/haos-rootfs-${{ env.HAOS_VERSION }}.tar.xz 2>/dev/null; then
              echo "Error: HAOS rootfs file ${{ env.HAOS_VERSION }} not found!"
              exit 1
            fi
            wget https://github.com/home-assistant/operating-system/releases/download/${{ env.HAOS_VERSION }}/haos-rootfs-${{ env.HAOS_VERSION }}.tar.xz
            mkdir -p rootfs && tar -xf haos-rootfs-${{ env.HAOS_VERSION }}.tar.xz -C rootfs
          fi

      - name: Build Kernel & DTB
        run: |
          cd ${{ env.WORK_DIR }}/linux-src
          source ~/.bashrc
          # 修复：增加配置文件检查，避免找不到 tn3399_v3_defconfig 时失败
          if [ ! -f ".config" ]; then
            if [ -f "arch/${{ env.ARCH }}/configs/tn3399_v3_defconfig" ]; then
              make tn3399_v3_defconfig
            else
              echo "Warning: tn3399_v3_defconfig not found, use rockchip_defconfig instead!"
              make rockchip_defconfig  # 降级使用RK3399通用配置，避免构建中断
            fi
          fi
          make -j$(nproc) ARCH=${{ env.ARCH }} CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            zImage dtbs modules
          make modules_install ARCH=${{ env.ARCH }} CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            INSTALL_MOD_PATH=${{ env.WORK_DIR }}/rootfs

      - name: Build HAOS Image
        run: |
          cd ${{ env.WORK_DIR }}
          # 检查内核和DTB是否生成，避免后续复制失败
          if [ ! -f "linux-src/arch/${{ env.ARCH }}/boot/zImage" ] || [ ! -f "linux-src/arch/${{ env.ARCH }}/boot/dts/rockchip/rk3399-tn3399-v3.dtb" ]; then
            echo "Error: Kernel zImage or DTB not generated!"
            exit 1
          fi
          cp linux-src/arch/${{ env.ARCH }}/boot/zImage rootfs/boot/
          cp linux-src/arch/${{ env.ARCH }}/boot/dts/rockchip/rk3399-tn3399-v3.dtb rootfs/boot/
          # 检查打包脚本是否存在（基于项目结构）
          if [ ! -f "./haos-repo/scripts/mkhaosimg.sh" ]; then
            echo "Error: mkhaosimg.sh script not found in haos-repo!"
            exit 1
          fi
          sudo ./haos-repo/scripts/mkhaosimg.sh \
            -v ${{ env.HAOS_VERSION }} \
            -k ${{ env.KERNEL_BRANCH }} \  # 此处可改为具体补丁版本（如6.12.35），不影响镜像命名
            -r rootfs \
            -o haos-tn3399-v3-${{ env.HAOS_VERSION }}.img

      - name: Upload HAOS Image
        uses: actions/upload-artifact@v4
        with:
          name: haos-tn3399-v3-${{ env.HAOS_VERSION }}
          path: ${{ env.WORK_DIR }}/haos-tn3399-v3-${{ env.HAOS_VERSION }}.img
          retention-days: 7
